# Práctica (2 / 2): Servidores Web, Base de Datos y DNS en nuestros escenario de OpenStack

## Servidor DNS

### 

```
root@luffy:~# iptables -t nat -A PREROUTING -i ens3 -p udp --dport 53 -j DNAT --to 192.168.0.2
```

### Vista externa

- Ahora llego el momento de crear la vista externa, esta es la que miraran los dispositivos ubicados fuera de la red intra y la dmz

- Para esto editamos el `/etc/bind/named.conf.local` y añadimos la nueva vista, quedaria tal que asi

```
view red_ext {
  match-clients { 172.22.0.0/16;};
  allow-recursion { any; };
    zone "aleeex.gonzalonazareno.org"
    {
      type master;
      file "db.aleeex_ext.gonzalonazareno.org";
    };
    include "/etc/bind/zones.rfc1918";
    include "/etc/bind/named.conf.default-zones";
};
```

- Ahora hay que crar `/var/cache/bind/db.aleeex_ext.gonzalonazareno.org` para eso usaremos `/var/cache/bind/db.aleeex.gonzalonazareno.org` como plantilla

```
sudo cp db.aleeex.gonzalonazareno.org db.aleeex_dmz.gonzalonazareno.org
```

- Lo editamos con `nano` o `vi`

```
sudo nano db.aleeex_dmz.gonzalonazareno.org 
```

- El fichero estará asi

```
; BIND reverse data file for empty rfc1918 zone
;
; DO NOT EDIT THIS FILE - it is used for multiple zones.
; Instead, copy it, edit named.conf, and use that copy.
;
$TTL    86400
@       IN      SOA     nami.aleeex.gonzalonazareno.org. root.aleeex.gonzalonazareno.org. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      nami.aleeex.gonzalonazareno.org.

$ORIGIN aleeex.gonzalonazareno.org.
nami                    IN      A       192.168.0.2
sanji                   IN      A       192.168.0.3
luffy                   IN      A       192.168.0.1
zoro                    IN      A       172.16.0.200
www                     IN      CNAME   zoro
bd                      IN      CNAME   sanji
```

- Debemos dejarlo de la siguente forma

```
; BIND reverse data file for empty rfc1918 zone
;
; DO NOT EDIT THIS FILE - it is used for multiple zones.
; Instead, copy it, edit named.conf, and use that copy.
;
$TTL    86400
@       IN      SOA     nami.aleeex.gonzalonazareno.org. root.aleeex.gonzalonazareno.org. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      luffy.aleeex.gonzalonazareno.org.

$ORIGIN aleeex.gonzalonazareno.org.
luffy                   IN      A       172.22.200.127
www                     IN      CNAME   luffy
```

- La única diferencia es que ahora cuando se haga una petición a Luffy nos dara su ip flotante 

- Guardamos y probamos su funcionamiento

```
dig @172.22.200.127 luffy.aleeex.gonzalonazareno.org

; <<>> DiG 9.18.28-1~deb12u2-Debian <<>> @172.22.200.127 luffy.aleeex.gonzalonazareno.org
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 49896
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 551fff92d7923c83010000006799d9724289bd204f05bf74 (good)
;; QUESTION SECTION:
;luffy.aleeex.gonzalonazareno.org. IN	A

;; ANSWER SECTION:
luffy.aleeex.gonzalonazareno.org. 86400	IN A	172.22.200.127

;; Query time: 4 msec
;; SERVER: 172.22.200.127#53(172.22.200.127) (UDP)
;; WHEN: Wed Jan 29 08:32:02 CET 2025
;; MSG SIZE  rcvd: 105
```

### Probar que funciona la delegacion

- Para eso hacemos peticiones para probarlo

```
dig NS aleeex.gonzalonazareno.org

; <<>> DiG 9.18.28-1~deb12u2-Debian <<>> NS aleeex.gonzalonazareno.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 46955
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: ec5012008f53ee1c010000006799dbdfd8c152dfaf58d57c (good)
;; QUESTION SECTION:
;aleeex.gonzalonazareno.org.	IN	NS

;; ANSWER SECTION:
aleeex.gonzalonazareno.org. 86014 IN	NS	luffy.aleeex.gonzalonazareno.org.

;; ADDITIONAL SECTION:
luffy.aleeex.gonzalonazareno.org. 86038	IN A	172.22.200.127

;; Query time: 0 msec
;; SERVER: 172.22.0.1#53(172.22.0.1) (UDP)
;; WHEN: Wed Jan 29 08:42:23 CET 2025
;; MSG SIZE  rcvd: 119
```

- Vemos que esta bien esa parte

```
dig www.aleeex.gonzalonazareno.org

; <<>> DiG 9.18.28-1~deb12u2-Debian <<>> www.aleeex.gonzalonazareno.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 63750
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: d943701ad666158e010000006799dc0e414cf6428cb80ace (good)
;; QUESTION SECTION:
;www.aleeex.gonzalonazareno.org.	IN	A

;; ANSWER SECTION:
www.aleeex.gonzalonazareno.org.	85991 IN CNAME	luffy.aleeex.gonzalonazareno.org.
luffy.aleeex.gonzalonazareno.org. 85991	IN A	172.22.200.127

;; Query time: 0 msec
;; SERVER: 172.22.0.1#53(172.22.0.1) (UDP)
;; WHEN: Wed Jan 29 08:43:10 CET 2025
;; MSG SIZE  rcvd: 123
```

- Y el cname tambien esta bien

---

### Que los demás puedan hacer peticiones

- Para esto añadimos lo siguente en `/etc/bind/named.conf.local`

```
forwarders {
    172.22.0.1; 
};
```

- Reiniciamos el servicio y probamos a hacerle una petición a uno de un compañero

```
dig www.javi.gonzalonazareno.org 

; <<>> DiG 9.18.28-1~deb12u2-Debian <<>> www.javi.gonzalonazareno.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 49134
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: c1bceb0c2cbd3561010000006799defe465042411a483cfc (good)
;; QUESTION SECTION:
;www.javi.gonzalonazareno.org.	IN	A

;; ANSWER SECTION:
www.javi.gonzalonazareno.org. 86400 IN	CNAME	luffy.javi.gonzalonazareno.org.
luffy.javi.gonzalonazareno.org.	86400 IN A	172.22.201.28

;; Query time: 0 msec
;; SERVER: 172.22.0.1#53(172.22.0.1) (UDP)
;; WHEN: Wed Jan 29 08:55:42 CET 2025
;; MSG SIZE  rcvd: 121
```

### Servidor Web

### Servidor base de datos

- Tambien instalaremos un sistema gestor de base de datos en sanji el cual sera `bd.aleeex.gonzalonazareno.org`el cual redirige a `sanji.aleeex.gonzalonazareno.org`

- Vamos a instalar mariadb

```bash
sudo apt install mariadb-server
```

- Y la configuramos de la siguiente forma

```
mysql_secure_installation

Switch to unix_socket authentication [Y/n] n

Change the root password? [Y/n] n

Remove anonymous users? [Y/n] y

Disallow root login remotely? [Y/n] y

Reload privilege tables now? [Y/n] y
```

- Nos conectamos a la base da datos

```sql
mysql -u root
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 38
Server version: 10.6.18-MariaDB-0ubuntu0.22.04.1 Ubuntu 22.04

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> 


/** Creamos la base de datos **/


CREATE DATABASE bd;
Query OK, 1 row affected (0.001 sec)


/** Creamos usuario y contraseña **/


CREATE USER 'bd_user' IDENTIFIED BY 'bd_password';
Query OK, 0 rows affected (0.003 sec)


/** Y le damos permisos **/


GRANT ALL PRIVILEGES ON bd.* TO 'bd_user'@'%';
Query OK, 0 rows affected (0.003 sec)


/** Y guardamos los privilegios**/


FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.001 sec)
```