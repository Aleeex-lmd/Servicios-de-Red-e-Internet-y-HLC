# Práctica (1 / 2): Servidores Web, Base de Datos y DNS en nuestros escenario de OpenStack

## Servidor DNS

### Instalacion de dependencias

- El primer paso antes de configurar el dns sera instalar el servidor dns en nami y dnsutils para el dig

```bash
sudo apt install bind9 dnsutils -y
```

- Dnsutils debemos instalarlo en todos dispositivos en los que vayamos a hacer peticiones con dig

---

### Primeros pasos

- Antes de configurar el dns debemos aconfigurar ciertas cosas

- En el fichero `/etc/default/named` cambiamos la siguente linea

```
OPTIONS="-u bind"
```

- Y la dejamos asi

```
OPTIONS="-4 -f -u bind"
```

- Tambien bien hay que cambiar dos cosas en `/etc/bind/named.conf.options`

- Lo primero añadimos la siguiente linea

```
        allow-query {any;};
```

- Esto permite que se puedan hacer consultas desde cualquier direccion

- Y la linea que esta asi la cambiamos

```
//      dnssec-validation auto;
```

- Asi debe quedar

```
      dnssec-validation no;
```

### Configuracion autoridad

- El servidor DNS se llamara nami.aleeex.gonzalonazareno.org y va a ser el servidor con autoridad para la zona aleeex.gonzalonazareno.org.

- Para esto primero creamos la zona, lo cual va en `/etc/bind/named.conf.local` y añadiremos el siguiente contenido

```bash
zone "aleeex.gonzalonazareno.org" {
    type master;
    file "db.aleeex.gonzalonazareno.org";
};
```

- Y creamos el fichero `/var/cache/bind/db.aleeex.gonzalonazaremo.org` para esto podemos usar como plantilla lo que hay en `/etc/bind/db.empty`


```bash
sudo cp /etc/bind/db.empty /var/cache/bind/db.aleeex.gonzalonazareno.org
```

- El contenido del fichero sera el siguiente

```conf
; BIND reverse data file for empty rfc1918 zone
;
; DO NOT EDIT THIS FILE - it is used for multiple zones.
; Instead, copy it, edit named.conf, and use that copy.
;
$TTL    86400
@       IN      SOA     localhost. root.localhost. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      localhost.
```

- Lo modificamos para que el servidor tenga autoridad sobre la zona, quedaria de la siguiente forma

```conf
; BIND reverse data file for empty rfc1918 zone
;
; DO NOT EDIT THIS FILE - it is used for multiple zones.
; Instead, copy it, edit named.conf, and use that copy.
;
$TTL    86400
@       IN      SOA     nami.aleeex.gonzalonazareno.org. root.aleeex.gonzalonazareno.org. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      nami.aleeex.gonzalonazareno.org.
```

- Guardamos y reiniciamos el servicio

```
sudo systemctl restart bind9
```

---

### Configuracion resuluciones

- Primero configuraremos el servidor para que resuelva el nombre de las maquinas del escenario

- Para esto debemos modificar el `/var/cache/bind/db.aleeex.gonzalonazaremo.org` para añadir los registros A de las maquinas

- Debemos añadir lo siguiente

```conf
$ORIGIN aleeex.gonzalonazareno.org.
nami                    IN      A       192.168.0.2
sanji                   IN      A       192.168.0.3
luffy                   IN      A       192.168.0.1   
zoro                    IN      A       172.16.0.200
```

- Reiniciamos el servicio y probamos que funcione

```bash
dig @192.168.0.2 aleeex.gonzalonazareno.org NS

; <<>> DiG 9.18.30-0ubuntu0.22.04.1-Ubuntu <<>> @192.168.0.2 aleeex.gonzalonazareno.org NS
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 50729
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: efc51d998bab503a010000006790ba815cb6deb24bdf8053 (good)
;; QUESTION SECTION:
;aleeex.gonzalonazareno.org.	IN	NS

;; ANSWER SECTION:
aleeex.gonzalonazareno.org. 86400 IN	NS	nami.aleeex.gonzalonazareno.org.

;; ADDITIONAL SECTION:
nami.aleeex.gonzalonazareno.org. 86400 IN A	192.168.0.2

;; Query time: 0 msec
;; SERVER: 192.168.0.2#53(192.168.0.2) (UDP)
;; WHEN: Wed Jan 22 09:29:37 UTC 2025
;; MSG SIZE  rcvd: 118
```

- Con esta linea podemos ver que la autoridad está correctamente configurada

```
aleeex.gonzalonazareno.org. 86400 IN	NS	nami.aleeex.gonzalonazareno.org.
```

- Ahora veremos que funcionan las otras resoluciones

---

#### **Nami**

```bash
dig nami.aleeex.gonzalonazareno.org 

; <<>> DiG 9.18.30-0ubuntu0.22.04.1-Ubuntu <<>> nami.aleeex.gonzalonazareno.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 25333
;; flags: qr aa rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;nami.aleeex.gonzalonazareno.org. IN	A

;; ANSWER SECTION:
nami.aleeex.gonzalonazareno.org. 0 IN	A	127.0.1.1

;; Query time: 4 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Wed Jan 22 09:50:18 UTC 2025
;; MSG SIZE  rcvd: 76
```

- En nami sale esa ip porque estamos haciendo las consultas desde esa máquina

---

#### **Sanji**

```bash
dig sanji.aleeex.gonzalonazareno.org 

; <<>> DiG 9.18.30-0ubuntu0.22.04.1-Ubuntu <<>> sanji.aleeex.gonzalonazareno.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 22317
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;sanji.aleeex.gonzalonazareno.org. IN	A

;; ANSWER SECTION:
sanji.aleeex.gonzalonazareno.org. 86400	IN A	192.168.0.3

;; Query time: 0 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Wed Jan 22 09:51:18 UTC 2025
;; MSG SIZE  rcvd: 77
```

---

#### **Luffy**

```bash
dig luffy.aleeex.gonzalonazareno.org 

; <<>> DiG 9.18.30-0ubuntu0.22.04.1-Ubuntu <<>> luffy.aleeex.gonzalonazareno.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 58080
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;luffy.aleeex.gonzalonazareno.org. IN	A

;; ANSWER SECTION:
luffy.aleeex.gonzalonazareno.org. 86400	IN A	192.168.0.1

;; Query time: 0 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Wed Jan 22 09:50:42 UTC 2025
;; MSG SIZE  rcvd: 77
```

---

#### **Zoro**

```bash
dig zoro.aleeex.gonzalonazareno.org 

; <<>> DiG 9.18.30-0ubuntu0.22.04.1-Ubuntu <<>> zoro.aleeex.gonzalonazareno.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 48230
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;zoro.aleeex.gonzalonazareno.org. IN	A

;; ANSWER SECTION:
zoro.aleeex.gonzalonazareno.org. 86400 IN A	172.16.0.200

;; Query time: 4 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Wed Jan 22 09:50:32 UTC 2025
;; MSG SIZE  rcvd: 76
```

---

### Servidor web en zoro

- Ahora vamos a añadir una redireccion de `www.aleeex.gonzalonazareno.org` el cual se redirigira a `zoro.aleeex.gonzalonazareno.org`

- Para esto añadimos lo siguiente en `/var/cache/bind/db.aleeex.gonzalonazareno.org` de nami

```conf
www                     IN      CNAME   zoro
```

- Reiniciamos el servicio y probamos que funciona

```
dig www.aleeex.gonzalonazareno.org 

; <<>> DiG 9.18.30-0ubuntu0.22.04.1-Ubuntu <<>> www.aleeex.gonzalonazareno.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 61725
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;www.aleeex.gonzalonazareno.org.	IN	A

;; ANSWER SECTION:
www.aleeex.gonzalonazareno.org.	86400 IN CNAME	zoro.aleeex.gonzalonazareno.org.
zoro.aleeex.gonzalonazareno.org. 86400 IN A	172.16.0.200

;; Query time: 0 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Wed Jan 22 11:36:26 UTC 2025
;; MSG SIZE  rcvd: 94
```

---

### Servidor base de datos en sanji

- Tambien vamos a añadir una redireccion de `bd.aleeex.gonzalonazareno.org`el cual redirige a `sanji.aleeex.gonzalonazareno.org`

- Para esto añadimos lo siguiente en `/var/cache/bind/db.aleeex.gonzalonazareno.org` de nami

```conf
bd                      IN      CNAME   sanji
```

- Reiniciamos el servicio y hacemos una consulta para probar el funcionamiento

```
dig bd.aleeex.gonzalonazareno.org 

; <<>> DiG 9.18.30-0ubuntu0.22.04.1-Ubuntu <<>> bd.aleeex.gonzalonazareno.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 59770
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;bd.aleeex.gonzalonazareno.org.	IN	A

;; ANSWER SECTION:
bd.aleeex.gonzalonazareno.org. 7045 IN	CNAME	sanji.aleeex.gonzalonazareno.org.
sanji.aleeex.gonzalonazareno.org. 7045 IN A	192.168.0.3

;; Query time: 0 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Wed Jan 22 11:17:28 UTC 2025
;; MSG SIZE  rcvd: 94
```

---

### Configuración vistas

- Ahora vamos a configurar las vistas en nami ya que depende desde donde la mires luffy tiene una ip o otra, las vistas son las siguientes.

    - **red_dmz**: Esta es la que miraran las maquinas conectadas a la red dmz, en este caso sera zoro

    - **red_intra**: Esta es la que miraran las maquinas conectadas a la red intra, las cuales son nami y sanji

    - **red_exterior**: Esta es la que miraran las maquinas que se encuentren en el exterior, pero esta vista no se configurara en este taller sino en el próximo

---

#### **Vista red_dmz**

- Vamos a crera una vista para la red_dmz ya que la que esta ahora mismo no se adapta a las maquinas de esa red ya que esta justo como se veria desde la red intra, duplicaremos el fichero cambiando los nombre

```
sudo cp db.aleeex.gonzalonazareno.org db.aleeex_dmz.gonzalonazareno.org
```

- Lo editamos con `nano` o `vi`

```
sudo nano db.aleeex_dmz.gonzalonazareno.org 
```

- El fichero estará asi

```
; BIND reverse data file for empty rfc1918 zone
;
; DO NOT EDIT THIS FILE - it is used for multiple zones.
; Instead, copy it, edit named.conf, and use that copy.
;
$TTL    86400
@       IN      SOA     nami.aleeex.gonzalonazareno.org. root.aleeex.gonzalonazareno.org. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      nami.aleeex.gonzalonazareno.org.

$ORIGIN aleeex.gonzalonazareno.org.
nami                    IN      A       192.168.0.2
sanji                   IN      A       192.168.0.3
luffy                   IN      A       192.168.0.1
zoro                    IN      A       172.16.0.200
www                     IN      CNAME   zoro
bd                      IN      CNAME   sanji
```

- Lo cambios que haremos seran
  - En luffy la ip que esta es la que se ve desde nami y sanji, la nueva ip sera la red_dmz es decir la `172.16.0.1`

- Con los cambios quedaria asi

```
; BIND reverse data file for empty rfc1918 zone
;
; DO NOT EDIT THIS FILE - it is used for multiple zones.
; Instead, copy it, edit named.conf, and use that copy.
;
$TTL    86400
@       IN      SOA     nami.aleeex.gonzalonazareno.org. root.aleeex.gonzalonazareno.org. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      nami.aleeex.gonzalonazareno.org.

$ORIGIN aleeex.gonzalonazareno.org.
nami                    IN      A       192.168.0.2
sanji                   IN      A       192.168.0.3
luffy                   IN      A       172.16.0.1
zoro                    IN      A       172.16.0.200
www                     IN      CNAME   zoro
bd                      IN      CNAME   sanji
```

- Tambien hay que editar el fichero `/etc/bind/named.conf.local` para añadir la vista

- Asi se ve el ficherio

```conf
//
// Do any local configuration here
//

// Consider adding the 1918 zones here, if they are not used in your
// organization
//include "/etc/bind/zones.rfc1918";

zone "aleeex.gonzalonazareno.org" {
    type master;
    file "db.aleeex.gonzalonazareno.org";
};
```

- Eso ya no lo necesitamos asi que borramos esa zona y creamos la siguiente vista

```conf
view red_dmz {
  match-clients { 172.16.0.0/16;};
  allow-recursion { any; };
    zone "aleeex.gonzalonazareno.org"
    {
      type master;
      file "db.aleeex_dmz.gonzalonazareno.org";
    };
    include "/etc/bind/zones.rfc1918";
    include "/etc/bind/named.conf.default-zones";
};
```

- Ahora reiniciamos el servicio y nos conectamos a zoro por ssh para probarlo

- Vamos a probarlo solo con luffy ya que es la única que hemos cambiado

```
dig luffy.aleeex.gonzalonazareno.org

; <<>> DiG 9.16.23-RH <<>> luffy.aleeex.gonzalonazareno.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 50419
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: fffc52db3185200b0100000067974446ccb3183311dfd489 (good)
;; QUESTION SECTION:
;luffy.aleeex.gonzalonazareno.org. IN	A

;; ANSWER SECTION:
luffy.aleeex.gonzalonazareno.org. 86400	IN A	172.16.0.1

;; Query time: 0 msec
;; SERVER: 192.168.0.2#53(192.168.0.2)
;; WHEN: Mon Jan 27 08:31:02 UTC 2025
;; MSG SIZE  rcvd: 105
```


---

#### **Vista red_intra**

- Vamos a usar el fichero `db.aleeex.gonzalonazareno.org` para esta vista ya que es igual que comola necesitamos pero vamos a renombrarla

```
cp db.aleeex.gonzalonazareno.org db.aleeex_intra.gonzalonazareno.org
```

- No hay que tocar nada del fichero, solo hay que añadir la vista

- La vista quedaria de la siguiente forma

```
view red_intra {
  match-clients { 192.168.0.0/24;};
  allow-recursion { any; };
    zone "aleeex.gonzalonazareno.org"
    {
      type master;
      file "db.aleeex_intra.gonzalonazareno.org";
    };
    include "/etc/bind/zones.rfc1918";
    include "/etc/bind/named.conf.default-zones";
};
```

- Reiniciamos y probamos su funcionamiento

- Solo probaremos con luffy

```
root@nami:/var/cache/bind# dig luffy.aleeex.gonzalonazareno.org

; <<>> DiG 9.18.30-0ubuntu0.22.04.1-Ubuntu <<>> luffy.aleeex.gonzalonazareno.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 15444
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;luffy.aleeex.gonzalonazareno.org. IN	A

;; ANSWER SECTION:
luffy.aleeex.gonzalonazareno.org. 6663 IN A	192.168.0.1

;; Query time: 8 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Mon Jan 27 08:46:24 UTC 2025
;; MSG SIZE  rcvd: 77
```

---

```
root@sanji:~# dig luffy.aleeex.gonzalonazareno.org

; <<>> DiG 9.18.30-0ubuntu0.22.04.1-Ubuntu <<>> luffy.aleeex.gonzalonazareno.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 49111
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;luffy.aleeex.gonzalonazareno.org. IN	A

;; ANSWER SECTION:
luffy.aleeex.gonzalonazareno.org. 86400	IN A	192.168.0.1

;; Query time: 12 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Mon Jan 27 08:46:03 UTC 2025
;; MSG SIZE  rcvd: 77
```

### Resolución inversa

- La resolucion inversa la tenemos que configurar en las zonas `192.168.0.0/24` y `172.16.0.0/16`

#### **192.168.0.0/24**

- Primero editamos el fichero `/etc/bind/named.conf.local` para añadir la resolucion inversa a la vista correspondiente

- Así esta sin la resolución inversa

```
view red_intra {
  match-clients { 192.168.0.0/24;};
  allow-recursion { any; };
    zone "aleeex.gonzalonazareno.org"
    {
      type master;
      file "db.aleeex_intra.gonzalonazareno.org";
    };
    include "/etc/bind/zones.rfc1918";
    include "/etc/bind/named.conf.default-zones";
};
```

- Y devría quedarnos así

```
view red_intra {
  match-clients { 192.168.0.0/24;};
  allow-recursion { any; };
    zone "aleeex.gonzalonazareno.org"
    {
      type master;
      file "db.aleeex_intra.gonzalonazareno.org";
    };
    zone "0.168.192.in-addr.arpa"
    {
      type master;
      file "db.0.168.192";
    };
    include "/etc/bind/zones.rfc1918";
    include "/etc/bind/named.conf.default-zones";
};
```

- Ahora tenemos que añadir el fichero `/var/cache/bind/db.0.168.192` podemos usar el que esta en `/etc/bind/db.empty` como plantilla

```
sudo cp /etc/bind/db.empty /var/cache/bind/db.0.168.192
```

- Lo editamos y lo dejamos de la siguiente forma

```
; BIND reverse data file for empty rfc1918 zone
;
; DO NOT EDIT THIS FILE - it is used for multiple zones.
; Instead, copy it, edit named.conf, and use that copy.
;
$TTL    86400
@       IN      SOA     nami.aleeex.gonzalonazareno.org. root.aleeex.gonzalonazareno.org. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      nami.aleeex.gonzalonazareno.org.

$ORIGIN 0.168.192.in-addr.arpa.

1                       IN      PTR     luffy.aleeex.gonzalonazareno.org
2                       IN      PTR     nami.aleeex.gonzalonazareno.org
3                       IN      PTR     sanji.aleeex.gonzalonazareno.org
```

- Y comentamos lo siguiente en `/etc/bind/zones.rfc1918`

```
zone "168.192.in-addr.arpa" { type master; file "/etc/bind/db.empty"; };
```

- Tras esto guardamos el archivo, reiniciamos el servicio y probamos su funcionamiento

```
dig -x 192.168.0.1

; <<>> DiG 9.18.30-0ubuntu0.22.04.1-Ubuntu <<>> -x 192.168.0.1
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 18945
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;1.0.168.192.in-addr.arpa.	IN	PTR

;; ANSWER SECTION:
1.0.168.192.in-addr.arpa. 86400	IN	PTR	luffy.aleeex.gonzalonazareno.org.0.168.192.in-addr.arpa.

;; Query time: 0 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Mon Jan 27 09:21:12 UTC 2025
;; MSG SIZE  rcvd: 100
```

---

```
dig -x 192.168.0.2

; <<>> DiG 9.18.30-0ubuntu0.22.04.1-Ubuntu <<>> -x 192.168.0.2
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 43148
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;2.0.168.192.in-addr.arpa.	IN	PTR

;; ANSWER SECTION:
2.0.168.192.in-addr.arpa. 7002	IN	PTR	nami.aleeex.gonzalonazareno.org.0.168.192.in-addr.arpa.

;; Query time: 0 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Mon Jan 27 09:24:27 UTC 2025
;; MSG SIZE  rcvd: 99
```

---

```
dig -x 192.168.0.3

; <<>> DiG 9.18.30-0ubuntu0.22.04.1-Ubuntu <<>> -x 192.168.0.3
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 36237
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;3.0.168.192.in-addr.arpa.	IN	PTR

;; ANSWER SECTION:
3.0.168.192.in-addr.arpa. 6975	IN	PTR	sanji.aleeex.gonzalonazareno.org.0.168.192.in-addr.arpa.

;; Query time: 0 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Mon Jan 27 09:24:43 UTC 2025
;; MSG SIZE  rcvd: 100
```

---

#### **172.16.0.0/16**

- Primero editamos el fichero `/etc/bind/named.conf.local` para añadir la resolucion inversa a la vista correspondiente

- Así esta sin la resolución inversa

```
view red_dmz {
  match-clients { 172.16.0.0/16;};
  allow-recursion { any; };
    zone "aleeex.gonzalonazareno.org"
    {
      type master;
      file "db.aleeex_dmz.gonzalonazareno.org";
    };
    include "/etc/bind/zones.rfc1918";
    include "/etc/bind/named.conf.default-zones";
};
```

- Con la resolucion inversa se ve de la siguiente forma

```
view red_dmz {
  match-clients { 172.16.0.0/16;};
  allow-recursion { any; };
    zone "aleeex.gonzalonazareno.org"
    {
      type master;
      file "db.aleeex_dmz.gonzalonazareno.org";
    };
    zone "16.172.in-addr.arpa"
    {
      type master;
      file "db.16.172";
    };

    include "/etc/bind/zones.rfc1918";
    include "/etc/bind/named.conf.default-zones";
};
```

- Ahora tenemos que añadir el fichero `/var/cache/bind/db.16.172` podemos usar el que esta en `/etc/bind/db.empty` como plantilla

```
sudo cp /etc/bind/db.empty /var/cache/bind/db.16.172
```

- Lo editamos y lo dejamos de la siguiente forma

```
; BIND reverse data file for empty rfc1918 zone
;
; DO NOT EDIT THIS FILE - it is used for multiple zones.
; Instead, copy it, edit named.conf, and use that copy.
;
$TTL    86400
@       IN      SOA     nami.aleeex.gonzalonazareno.org. root.aleeex.gonzalonazareno.org. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      nami.aleeex.gonzalonazareno.org.

$ORIGIN 16.172.in-addr.arpa.

1.0                     IN      PTR     luffy.aleeex.gonzalonazareno.org
200.0                   IN      PTR     zoro.aleeex.gonzalonazareno.org
```

- Y comentamos lo siguiente en `/etc/bind/zones.rfc1918`

```
zone "16.172.in-addr.arpa" { type master; file "/etc/bind/db.empty"; };
```

- Reiniciamos y probampos que funciona

```
dig -x 172.16.0.1

; <<>> DiG 9.16.23-RH <<>> -x 172.16.0.1
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 34964
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 222b575c72e6c890010000006797585df6a6c27bedaa9c61 (good)
;; QUESTION SECTION:
;1.0.16.172.in-addr.arpa.	IN	PTR

;; ANSWER SECTION:
1.0.16.172.in-addr.arpa. 86400	IN	PTR	luffy.aleeex.gonzalonazareno.org.16.172.in-addr.arpa.

;; Query time: 2 msec
;; SERVER: 192.168.0.2#53(192.168.0.2)
;; WHEN: Mon Jan 27 09:56:45 UTC 2025
;; MSG SIZE  rcvd: 146
```

---

```
dig -x 172.16.0.200

; <<>> DiG 9.16.23-RH <<>> -x 172.16.0.200
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 47792
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: ad262ec5f477459301000000679758bcfb7e9b7421ce560b (good)
;; QUESTION SECTION:
;200.0.16.172.in-addr.arpa.	IN	PTR

;; ANSWER SECTION:
200.0.16.172.in-addr.arpa. 86400 IN	PTR	zoro.aleeex.gonzalonazareno.org.16.172.in-addr.arpa.

;; Query time: 2 msec
;; SERVER: 192.168.0.2#53(192.168.0.2)
;; WHEN: Mon Jan 27 09:58:20 UTC 2025
;; MSG SIZE  rcvd: 147
```

### Configurar nami como servidor DNS

- Esto se hace de diferentes formas dependiendo de las máquinas que vayamos a configurar


#### **Luffy Nami y Sanji**

- Estos son sencillos ya que usamos dns estatico

- Debemos editar el siguiente fichero

```bash
sudo nano /etc/systemd/resolved.conf 
```

- Descomentamos la linea qye esta `#DNS=` y ponemos la ip del servidor DNS
- Ahora guardamos y reiniciamos para ver si funciona


```bash
resolvectl status
Global
       Protocols: -LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported
resolv.conf mode: stub
     DNS Servers: 192.168.0.2

Link 2 (eth0)
Current Scopes: DNS
     Protocols: +DefaultRoute +LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported
   DNS Servers: 172.22.0.1
```

---

#### **Zoro**

- Desde Zoro es distito ya que rocky linux usa `network manager`

- Primero listamos las redes

```bash
sudo nmcli connection show
NAME         UUID                                  TYPE      DEVICE 
dmz-static   5b762dc6-0bf0-488f-b729-739699dc75e2  ethernet  eth0   
lo           42b203a6-e01d-4b85-a57f-4ad46cc88451  loopback  lo     
```

- Añadimos el DNS a dmz static

```bash
sudo nmcli connection modify "dmz-static" ipv4.dns "192.168.0.2"
sudo nmcli connection modify "dmz-static" ipv4.ignore-auto-dns yes
```

- Reiniciamos y probamos a ver si esta aun

- Podemos ver que esta guardada usando lo siguiente

```bash
nmcli connection show "dmz-static"
```

- Si sale lo siguiente es que esta bien configurado

```bash
ipv4.dns:                               192.168.0.2
```

### Configurar parámetro search

- Esto se hará tambien de distintas formas dependiendo de la maquina pero se parecen a su equivalente del ejercicio anterior

#### **Luffy Nami y Sanji**

- Estos son sencillos ya que usamos dns estatico

- Debemos editar el siguiente fichero

```bash
sudo nano /etc/systemd/resolved.conf 
```

- Descomentamos la linea qye esta `#Domains=` y ponemos `aleeex.gonzalonazareno.org`
- Ahora guardamos y reiniciamos para ver si funciona

```bash
resolvectl status
Global
       Protocols: -LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported
resolv.conf mode: stub
     DNS Servers: 192.168.0.2
      DNS Domain: aleeex.gonzalonazareno.org

Link 2 (eth0)
Current Scopes: DNS
     Protocols: +DefaultRoute +LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported
   DNS Servers: 172.22.0.1
```

---

#### **Zoro**


- Desde Zoro es distito ya que rocky linux usa `network manager`

- Primero listamos las redes

```bash
sudo nmcli connection show
NAME         UUID                                  TYPE      DEVICE 
dmz-static   5b762dc6-0bf0-488f-b729-739699dc75e2  ethernet  eth0   
lo           42b203a6-e01d-4b85-a57f-4ad46cc88451  loopback  lo     
```

- Añadimos el DNS a dmz static

```bash
nmcli connection modify "dmz-static" ipv4.dns-search "aleeex.gonzalonazareno.org"
```

- Si eso no funciona en el `/etc/resolv.conf` añadimos lo siguiente

```conf
search aleeex.gonzalonazareno.org
```

- Reiniciamos y probamos a ver si esta aun

- Podemos ver que esta guardada usando lo siguiente

```bash
nmcli connection show "dmz-static"
```

- Si sale lo siguiente es que esta bien configurado

```bash
ipv4.dns-search:                        aleeex.gonzalonazareno.org
```

### Comprobaciones

#### **Desde Luffy**

```bash
alex@luffy:~$ ping -c 3 zoro
PING zoro.aleeex.gonzalonazareno.org (172.16.0.200) 56(84) bytes of data.
64 bytes from 172.16.0.200 (172.16.0.200): icmp_seq=1 ttl=64 time=1.26 ms
64 bytes from 172.16.0.200 (172.16.0.200): icmp_seq=2 ttl=64 time=0.354 ms
64 bytes from 172.16.0.200 (172.16.0.200): icmp_seq=3 ttl=64 time=0.516 ms

--- zoro.aleeex.gonzalonazareno.org ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 0.354/0.708/1.255/0.392 ms
```

---

```bash
alex@luffy:~$ ssh sanji
Welcome to Ubuntu 22.04.5 LTS (GNU/Linux 6.1.0-30-amd64 x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro
Last login: Tue Jan 28 08:01:46 2025 from 192.168.0.1
alex@sanji:~$ 
```

#### **Desde Nami**

```bash
alex@nami:~$ ping -c 3 zoro
PING zoro.aleeex.gonzalonazareno.org (172.16.0.200) 56(84) bytes of data.
64 bytes from 172.16.0.200 (172.16.0.200): icmp_seq=1 ttl=63 time=0.481 ms
64 bytes from 172.16.0.200 (172.16.0.200): icmp_seq=2 ttl=63 time=0.604 ms
64 bytes from 172.16.0.200 (172.16.0.200): icmp_seq=3 ttl=63 time=0.607 ms

--- zoro.aleeex.gonzalonazareno.org ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2004ms
rtt min/avg/max/mdev = 0.481/0.564/0.607/0.058 ms
```

---

```bash
alex@nami:~$ ssh sanji
Welcome to Ubuntu 22.04.5 LTS (GNU/Linux 6.1.0-30-amd64 x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro
Last login: Tue Jan 28 08:03:27 2025 from 192.168.0.1
alex@sanji:~$ 
```

#### **Desde Sanji**

- Solo haremos ping ya que no tiene sentido hacer ssh a si mismo

```
alex@sanji:~$ ping -c 3 zoro
PING zoro.aleeex.gonzalonazareno.org (172.16.0.200) 56(84) bytes of data.
64 bytes from 172.16.0.200 (172.16.0.200): icmp_seq=1 ttl=63 time=0.632 ms
64 bytes from 172.16.0.200 (172.16.0.200): icmp_seq=2 ttl=63 time=0.715 ms
64 bytes from 172.16.0.200 (172.16.0.200): icmp_seq=3 ttl=63 time=0.416 ms

--- zoro.aleeex.gonzalonazareno.org ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 0.416/0.587/0.715/0.126 ms
```

#### **Desde Zoro**

- Aqui solo probaremos el ssh

```bash
[alex@zoro ~]$ ssh sanji
Welcome to Ubuntu 22.04.5 LTS (GNU/Linux 6.1.0-30-amd64 x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro
Last login: Tue Jan 28 08:17:20 2025 from 172.16.0.200
alex@sanji:~$ 
```